{% extends 'base.html' %}

{% block content %}
<h1>Posts</h1>
<ul>
    {% for post in posts %}
    <li>
        <h2>{{ post.title }}</h2>
        <p>{{ post.content }}</p>
        <p>By {{ post.author.username }} on {{ post.date_posted }}</p>
        <div id="like-post-{{ post.id }}">
            <form hx-post="{% url 'social:like_post' post.id %}" hx-trigger="submit" hx-swap="outerHTML"
                hx-target="#like-post-{{ post.id }}" id="like-form-{{ post.id }}" data-post-id="{{ post.id }}">
                {% csrf_token %}
                <span id="likes-count-{{ post.id }}">{{ post.num_likes }}</span>
                <button type="submit" id="like-button-{{ post.id }}">
                    {% if request.user in post.like.all %}
                    Unlike
                    {% else %}
                    Like
                    {% endif %}
                </button>
            </form>
        </div>
    </li>
    {% endfor %}
</ul>

<script>
    document.querySelectorAll('form').forEach((form) => {
        form.addEventListener('htmx:afterSwap', (event) => {
            const data = JSON.parse(event.detail.xhr.response);
            const postId = form.dataset.postId;
            const likesCountSpan = document.querySelector(`#likes-count-${postId}`);
            likesCountSpan.innerText = data.likes_count;

            const likeButton = document.querySelector(`#like-button-${postId}`);
            if (data.likes_count > 0 && likeButton.innerText === 'Like') {
                likeButton.innerText = 'Unlike';
            } else if (data.likes_count === 0 && likeButton.innerText === 'Unlike') {
                likeButton.innerText = 'Like';
            }
        });
    });
</script>
{% endblock %}