{% extends 'base.html' %}

{% block content %}
<h1>Posts</h1>
<ul>
    {% for post in posts %}
    <li>
        <h2>{{ post.title }}</h2>
        <p>{{ post.content }}</p>
        <p>By {{ post.author.username }} on {{ post.date_posted }}</p>
        <div id="like-post-{{ post.id }}">
            <span id="likes-count-{{ post.id }}">{{ post.num_likes }}</span>
            <button hx-post="{% url 'social:like_post' post.id %}" hx-trigger="click"
                hx-headers='{ "X-CSRFToken": "{{ csrf_token }}" }'>
                ll
                {% if request.user in post.like.all %}
                Unlike
                {% else %}
                Like
                {% endif %}
            </button>
        </div>
    </li>
    {% endfor %}
</ul>

<script>
    document.addEventListener('htmx:afterSwap', function (event) {
        var target = event.detail.target;
        if (target.tagName === 'BUTTON' && target.hasAttribute('hx-post')) {
            var response = event.detail.xhr.response;
            var likesCount = response.likes_count;
            var postId = target.getAttribute('hx-post').match(/(\d+)\/$/)[1];
            var likesCountSpan = document.getElementById('likes-count-' + postId);
            likesCountSpan.textContent = likesCount;
        }
    });
</script>
{% endblock %}